{
  "RefreshIntervalMs": 1000,
  "QueryTimeoutSeconds": 30,
  "Queries": {
    "Metrics": {
      "Description": "Server metrics including CPU, wait stats, and performance counters",
      "Enabled": true,
      "TimeoutSeconds": 30,
      "RefreshEveryNTicks": 1,
      "Sql": "DECLARE @BR BIGINT, @SC BIGINT, @TR BIGINT, @cpu INT\nSELECT @BR=ISNULL(SUM(CONVERT(BIGINT,cntr_value)),0) FROM sys.dm_os_performance_counters WITH(NOLOCK) WHERE LOWER(object_name) LIKE '%sql statistics%' AND LOWER(counter_name)='batch requests/sec'\nSELECT @SC=ISNULL(SUM(CONVERT(BIGINT,cntr_value)),0) FROM sys.dm_os_performance_counters WITH(NOLOCK) WHERE LOWER(object_name) LIKE '%sql statistics%' AND LOWER(counter_name)='sql compilations/sec'\nSELECT @TR=ISNULL(SUM(CONVERT(BIGINT,cntr_value)),0) FROM sys.dm_os_performance_counters WITH(NOLOCK) WHERE LOWER(object_name) LIKE '%databases%' AND LOWER(counter_name)='transactions/sec' AND LOWER(instance_name)<>'_total'\nSELECT TOP 1 @cpu=CONVERT(XML,record).value('(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]','int') FROM sys.dm_os_ring_buffers WITH(NOLOCK) WHERE ring_buffer_type='RING_BUFFER_SCHEDULER_MONITOR' ORDER BY timestamp DESC\nSELECT ISNULL(@cpu,0) AS CPU,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE 'LCK%' THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Locks,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE 'LATCH%' OR wait_type LIKE 'PAGELATCH%' OR wait_type LIKE 'PAGEIOLATCH%' THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Reads,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE '%IO_COMPLETION%' OR wait_type='WRITELOG' THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Writes,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN('NETWORKIO','OLEDB','ASYNC_NETWORK_IO') THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Network,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE 'BACKUP%' THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS [Backup],\nSUM(CONVERT(BIGINT,CASE WHEN wait_type='CMEMTHREAD' OR wait_type LIKE 'RESOURCE_SEMAPHORE%' THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Memory,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN('CXPACKET','EXCHANGE') THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Parallelism,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN('LOGBUFFER','LOGMGR','WRITELOG') THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS TransactionLog,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN('IO_QUEUE_LIMIT', 'IO_RETRY', 'LOG_RATE_GOVERNOR', 'POOL_LOG_RATE_GOVERNOR', 'PREEMPTIVE_DEBUG', 'RESMGR_THROTTLED', 'RESOURCE_SEMAPHORE', 'RESOURCE_SEMAPHORE_QUERY_COMPILE','SE_REPL_CATCHUP_THROTTLE','SE_REPL_COMMIT_ACK','SE_REPL_COMMIT_TURN','SE_REPL_ROLLBACK_ACK','SE_REPL_SLOW_SECONDARY_THROTTLE','THREADPOOL')THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS PoisonWaits,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN('LCK_M_RS_S', 'LCK_M_RS_U', 'LCK_M_RIn_NL','LCK_M_RIn_S', 'LCK_M_RIn_U','LCK_M_RIn_X', 'LCK_M_RX_S', 'LCK_M_RX_U','LCK_M_RX_X')THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS [Poison Serializable Locking],\nSUM(CONVERT(BIGINT,CASE WHEN wait_type = 'CMEMTHREAD' THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS [Poison CMEMTHREAD and NUMA],\n@@TOTAL_READ AS PhReads,@@TOTAL_WRITE AS PhWrites,@BR AS BatchReq,@SC AS SqlComp,@TR AS Trans\nFROM sys.dm_os_wait_stats WITH(NOLOCK)"
    },
    "Sessions": {
      "Description": "Active sessions with CPU and I/O metrics",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 1,
      "TopN": 20,
      "Sql": "SELECT TOP {TopN} s.spid AS Spid,\n    DB_NAME(s.dbid) AS [Database],\n    status AS Status,\n    CAST(cpu AS BIGINT) AS Cpu,\n    CAST(physical_io AS BIGINT) AS PhysicalIo,\n    hostname AS Hostname,\n    program_name AS ProgramName,\n    loginame AS LoginName,\n    cmd AS Command,\n    CASE WHEN last_batch IS NULL OR last_batch < DATEADD(DAY, -30, GETDATE()) THEN 999999 \n         ELSE DATEDIFF(SECOND, last_batch, GETDATE()) END AS IdleSeconds,\n    ISNULL(SomeText.text,'') [text],\n    s.blocked\nFROM sys.sysprocesses s\nLEFT OUTER JOIN (\n    SELECT spid AS Spid, e.text\n    FROM sys.sysprocesses s WITH (NOLOCK)\n    CROSS APPLY sys.dm_exec_sql_text(sql_handle) e\n) SomeText ON SomeText.spid = s.spid\nWHERE s.spid > 50 \n    AND program_name NOT LIKE '%SQLMonitorUI%'\n    AND hostname <> ''\n    AND program_name <> ''\n{StatusFilter}\n{ProgramFilter}\nORDER BY (ISNULL(cpu,0) + ISNULL(physical_io,0)) DESC"
    },
    "Blocking": {
      "Description": "Current blocking chains",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 1,
      "Sql": "SELECT \n    l.request_session_id AS WaitSpid,\n    DB_NAME(l.resource_database_id) AS DatabaseName,\n    l.resource_type AS LockType,\n    l.request_mode AS RequestMode,\n    l.request_status AS RequestStatus,\n    wt.blocking_session_id AS BlockerSpid,\n    wt.wait_type AS WaitType,\n    wt.wait_duration_ms AS WaitDurationMs,\n    ISNULL(wst.text, '') AS WaitStatement,\n    ISNULL(bst.text, '') AS BlockerStatement\nFROM sys.dm_tran_locks l WITH (NOLOCK)\nJOIN sys.dm_os_waiting_tasks wt WITH (NOLOCK) ON l.lock_owner_address = wt.resource_address\nOUTER APPLY sys.dm_exec_sql_text((SELECT sql_handle FROM sys.dm_exec_requests WHERE session_id = l.request_session_id)) wst\nOUTER APPLY sys.dm_exec_sql_text((SELECT sql_handle FROM sys.dm_exec_requests WHERE session_id = wt.blocking_session_id)) bst\nWHERE wt.blocking_session_id IS NOT NULL\nORDER BY wt.wait_duration_ms DESC"
    },
    "TopQueries": {
      "Description": "Top queries by I/O - runs less frequently",
      "Enabled": true,
      "TimeoutSeconds": 30,
      "RefreshEveryNTicks": 30,
      "Sql": "SELECT\n    TMP.Category,\n    DB_NAME(st.dbid) [DB],\n    TMP.[Total Elapsed Time in S],\n    TMP.[Total Execution Count],\n    TMP.[Total CPU Time in S],\n    TMP.[Total Logical Reads],\n    TMP.[Total Logical Writes],\n    TMP.[Total CLR Time],\n    TMP.[Number of Statements],\n    TMP.[Last Execution Time],\n    TMP.[Plan Handle],\n    st.text AS [Query],\n    qp.query_plan AS [Plan]\nFROM (\n    SELECT * FROM (\n        SELECT TOP 10 'worst I/O' [Category],\n            CAST(SUM(s.total_elapsed_time) / 1000000.0 AS DECIMAL(20, 2)) AS [Total Elapsed Time in S],\n            SUM(s.execution_count) AS [Total Execution Count],\n            CAST(SUM(s.total_worker_time) / 1000000.0 AS DECIMAL(20, 2)) AS [Total CPU Time in S],\n            SUM(s.total_logical_reads) AS [Total Logical Reads],\n            SUM(s.total_logical_writes) AS [Total Logical Writes],\n            SUM(s.total_clr_time) AS [Total CLR Time],\n            COUNT(1) AS [Number of Statements],\n            MAX(s.last_execution_time) AS [Last Execution Time],\n            s.plan_handle AS [Plan Handle]\n        FROM sys.dm_exec_query_stats s WITH (NOLOCK)\n        GROUP BY s.plan_handle ORDER BY SUM(s.total_logical_reads + s.total_logical_writes) DESC\n    ) TT\n) TMP\nOUTER APPLY sys.dm_exec_sql_text(TMP.[Plan Handle]) AS st\nOUTER APPLY sys.dm_exec_query_plan(TMP.[Plan Handle]) AS qp\nORDER BY Category, [Total Logical Reads] DESC\nOPTION (MAXDOP 1)"
    },
    "DriveLatency": {
      "Description": "Drive I/O latency statistics",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 30,
      "Sql": "SELECT TOP 1\n    LEFT(f.physical_name, 1) AS Drive,\n    CAST(SUM(fs.io_stall_read_ms) / NULLIF(SUM(fs.num_of_reads), 0) AS DECIMAL(10,2)) AS ReadLatencyMs,\n    CAST(SUM(fs.io_stall_write_ms) / NULLIF(SUM(fs.num_of_writes), 0) AS DECIMAL(10,2)) AS WriteLatencyMs,\n    CAST((SUM(fs.io_stall_read_ms) + SUM(fs.io_stall_write_ms)) / NULLIF(SUM(fs.num_of_reads) + SUM(fs.num_of_writes), 0) AS DECIMAL(10,2)) AS LatencyMs,\n    CAST(SUM(fs.num_of_bytes_read + fs.num_of_bytes_written) / 1024.0 / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS GBPerDay,\n    '' AS FreeSpace\nFROM sys.dm_io_virtual_file_stats(NULL, NULL) fs\nJOIN sys.master_files f ON fs.database_id = f.database_id AND fs.file_id = f.file_id\nGROUP BY LEFT(f.physical_name, 1)\nORDER BY LatencyMs DESC"
    },
    "ServerDetails": {
      "Description": "Server configuration and version info",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 60,
      "Sql": "SELECT \n    @@SERVERNAME AS ServerName,\n    SERVERPROPERTY('Edition') AS Edition,\n    (SELECT cpu_count FROM sys.dm_os_sys_info) AS VirtualCPUs,\n    (SELECT socket_count FROM sys.dm_os_sys_info) AS Sockets,\n    CASE WHEN (SELECT virtual_machine_type FROM sys.dm_os_sys_info) = 1 THEN 'VM' ELSE 'Physical' END AS VMType,\n    CAST((SELECT physical_memory_kb FROM sys.dm_os_sys_info) / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS MemoryGB,\n    CAST((SELECT committed_kb FROM sys.dm_os_sys_info) / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS SqlAllocated,\n    CAST((SELECT committed_target_kb FROM sys.dm_os_sys_info) / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS UsedBySql,\n    '' AS MemoryState,\n    @@VERSION AS [Version],\n    SERVERPROPERTY('ProductVersion') AS BuildNr,\n    (SELECT windows_release FROM sys.dm_os_windows_info) AS OS,\n    CASE WHEN SERVERPROPERTY('IsHadrEnabled') = 1 THEN 'Yes' ELSE 'No' END AS HADR,\n    CASE WHEN EXISTS(SELECT 1 FROM sys.server_principals WHERE name = 'sa' AND is_disabled = 0) THEN 'Enabled' ELSE 'Disabled' END AS SA,\n    '' AS [Level]"
    }
  },
  "Notes": {
    "Placeholders": {
      "{TopN}": "Replaced with TopN value from Sessions config",
      "{StatusFilter}": "Replaced with 'AND status <> ''sleeping''' if filtering sleeping SPIDs",
      "{ProgramFilter}": "Replaced with 'AND program_name LIKE ''%filter%''' if program filter is set"
    },
    "TuningTips": [
      "Increase RefreshEveryNTicks for expensive queries on busy servers",
      "Reduce TopN in Sessions query if too many active connections",
      "Disable queries you don't need by setting Enabled to false",
      "Increase TimeoutSeconds if queries are timing out",
      "Add WITH (NOLOCK) hints for less blocking on busy systems"
    ]
  }
}
