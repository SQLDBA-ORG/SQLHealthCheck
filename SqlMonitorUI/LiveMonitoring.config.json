{
  "RefreshIntervalMs": 1000,
  "QueryTimeoutSeconds": 30,
  "Queries": {
    "Metrics": {
      "Description": "Server metrics including CPU, wait stats, and performance counters",
      "Enabled": true,
      "TimeoutSeconds": 30,
      "RefreshEveryNTicks": 1,
      "Sql": "DECLARE @BR BIGINT, @SC BIGINT, @TR BIGINT, @cpu INT\nSELECT @BR=ISNULL(SUM(CONVERT(BIGINT,cntr_value)),0) FROM sys.dm_os_performance_counters WITH(NOLOCK) WHERE LOWER(object_name) LIKE \u0027%sql statistics%\u0027 AND LOWER(counter_name)=\u0027batch requests/sec\u0027\nSELECT @SC=ISNULL(SUM(CONVERT(BIGINT,cntr_value)),0) FROM sys.dm_os_performance_counters WITH(NOLOCK) WHERE LOWER(object_name) LIKE \u0027%sql statistics%\u0027 AND LOWER(counter_name)=\u0027sql compilations/sec\u0027\nSELECT @TR=ISNULL(SUM(CONVERT(BIGINT,cntr_value)),0) FROM sys.dm_os_performance_counters WITH(NOLOCK) WHERE LOWER(object_name) LIKE \u0027%databases%\u0027 AND LOWER(counter_name)=\u0027transactions/sec\u0027 AND LOWER(instance_name)\u003C\u003E\u0027_total\u0027\nSELECT TOP 1 @cpu=CONVERT(XML,record).value(\u0027(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]\u0027,\u0027int\u0027) FROM sys.dm_os_ring_buffers WITH(NOLOCK) WHERE ring_buffer_type=\u0027RING_BUFFER_SCHEDULER_MONITOR\u0027 ORDER BY timestamp DESC\nSELECT ISNULL(@cpu,0) AS CPU,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE \u0027LCK%\u0027 THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Locks,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE \u0027LATCH%\u0027 OR wait_type LIKE \u0027PAGELATCH%\u0027 OR wait_type LIKE \u0027PAGEIOLATCH%\u0027 THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Reads,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE \u0027%IO_COMPLETION%\u0027 OR wait_type=\u0027WRITELOG\u0027 THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Writes,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN(\u0027NETWORKIO\u0027,\u0027OLEDB\u0027,\u0027ASYNC_NETWORK_IO\u0027) THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Network,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type LIKE \u0027BACKUP%\u0027 THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS [Backup],\nSUM(CONVERT(BIGINT,CASE WHEN wait_type=\u0027CMEMTHREAD\u0027 OR wait_type LIKE \u0027RESOURCE_SEMAPHORE%\u0027 THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Memory,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN(\u0027CXPACKET\u0027,\u0027EXCHANGE\u0027) THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS Parallelism,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN(\u0027LOGBUFFER\u0027,\u0027LOGMGR\u0027,\u0027WRITELOG\u0027) THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS TransactionLog,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN(\u0027IO_QUEUE_LIMIT\u0027, \u0027IO_RETRY\u0027, \u0027LOG_RATE_GOVERNOR\u0027, \u0027POOL_LOG_RATE_GOVERNOR\u0027, \u0027PREEMPTIVE_DEBUG\u0027, \u0027RESMGR_THROTTLED\u0027, \u0027RESOURCE_SEMAPHORE\u0027, \u0027RESOURCE_SEMAPHORE_QUERY_COMPILE\u0027,\u0027SE_REPL_CATCHUP_THROTTLE\u0027,\u0027SE_REPL_COMMIT_ACK\u0027,\u0027SE_REPL_COMMIT_TURN\u0027,\u0027SE_REPL_ROLLBACK_ACK\u0027,\u0027SE_REPL_SLOW_SECONDARY_THROTTLE\u0027,\u0027THREADPOOL\u0027)THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS PoisonWaits,\nSUM(CONVERT(BIGINT,CASE WHEN wait_type IN(\u0027LCK_M_RS_S\u0027, \u0027LCK_M_RS_U\u0027, \u0027LCK_M_RIn_NL\u0027,\u0027LCK_M_RIn_S\u0027, \u0027LCK_M_RIn_U\u0027,\u0027LCK_M_RIn_X\u0027, \u0027LCK_M_RX_S\u0027, \u0027LCK_M_RX_U\u0027,\u0027LCK_M_RX_X\u0027)THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS [Poison Serializable Locking],\nSUM(CONVERT(BIGINT,CASE WHEN wait_type = \u0027CMEMTHREAD\u0027 THEN wait_time_ms-signal_wait_time_ms ELSE 0 END)) AS [Poison CMEMTHREAD and NUMA],\n@@TOTAL_READ AS PhReads,@@TOTAL_WRITE AS PhWrites,@BR AS BatchReq,@SC AS SqlComp,@TR AS Trans\nFROM sys.dm_os_wait_stats WITH(NOLOCK)"
    },
    "Sessions": {
      "TopN": 20,
      "Description": "Active sessions with CPU and I/O metrics",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 1,
      "Sql": "SELECT TOP {TopN} s.spid AS Spid,\n    DB_NAME(s.dbid) AS [Database],\n    status AS Status,\n    CAST(cpu AS BIGINT) AS Cpu,\n    CAST(physical_io AS BIGINT) AS PhysicalIo,\n    hostname AS Hostname,\n    program_name AS ProgramName,\n    loginame AS LoginName,\n    cmd AS Command,\n    CASE WHEN last_batch IS NULL OR last_batch \u003C DATEADD(DAY, -30, GETDATE()) THEN 999999 \n         ELSE DATEDIFF(SECOND, last_batch, GETDATE()) END AS IdleSeconds,\n    ISNULL(SomeText.text,\u0027\u0027) [text],\n    s.blocked\nFROM sys.sysprocesses s\nLEFT OUTER JOIN (\n    SELECT spid AS Spid, e.text\n    FROM sys.sysprocesses s WITH (NOLOCK)\n    CROSS APPLY sys.dm_exec_sql_text(sql_handle) e\n) SomeText ON SomeText.spid = s.spid\nWHERE s.spid \u003E 50 \n    AND program_name NOT LIKE \u0027%SQLMonitorUI%\u0027\n    AND hostname \u003C\u003E \u0027\u0027\n    AND program_name \u003C\u003E \u0027\u0027\n{StatusFilter}\n{ProgramFilter}\nORDER BY (ISNULL(cpu,0) \u002B ISNULL(physical_io,0)) DESC"
    },
    "Blocking": {
      "Description": "Current blocking chains",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 1,
      "Sql": "SELECT \n    l.request_session_id AS WaitSpid,\n    DB_NAME(l.resource_database_id) AS DatabaseName,\n    l.resource_type AS LockType,\n    l.request_mode AS RequestMode,\n    l.request_status AS RequestStatus,\n    wt.blocking_session_id AS BlockerSpid,\n    wt.wait_type AS WaitType,\n    wt.wait_duration_ms AS WaitDurationMs,\n    ISNULL(wst.text, \u0027\u0027) AS WaitStatement,\n    ISNULL(bst.text, \u0027\u0027) AS BlockerStatement\nFROM sys.dm_tran_locks l WITH (NOLOCK)\nJOIN sys.dm_os_waiting_tasks wt WITH (NOLOCK) ON l.lock_owner_address = wt.resource_address\nOUTER APPLY sys.dm_exec_sql_text((SELECT sql_handle FROM sys.dm_exec_requests WHERE session_id = l.request_session_id)) wst\nOUTER APPLY sys.dm_exec_sql_text((SELECT sql_handle FROM sys.dm_exec_requests WHERE session_id = wt.blocking_session_id)) bst\nWHERE wt.blocking_session_id IS NOT NULL\nORDER BY wt.wait_duration_ms DESC"
    },
    "TopQueries": {
      "Description": "Top queries by I/O - runs less frequently",
      "Enabled": true,
      "TimeoutSeconds": 30,
      "RefreshEveryNTicks": 30,
      "Sql": "SELECT\n    TMP.Category,\n    DB_NAME(st.dbid) [DB],\n    TMP.[Total Elapsed Time in S],\n    TMP.[Total Execution Count],\n    TMP.[Total CPU Time in S],\n    TMP.[Total Logical Reads],\n    TMP.[Total Logical Writes],\n    TMP.[Total CLR Time],\n    TMP.[Number of Statements],\n    TMP.[Last Execution Time],\n    TMP.[Plan Handle],\n    st.text AS [Query],\n    qp.query_plan AS [Plan]\nFROM (\n    SELECT * FROM (\n        SELECT TOP 10 \u0027worst I/O\u0027 [Category],\n            CAST(SUM(s.total_elapsed_time) / 1000000.0 AS DECIMAL(20, 2)) AS [Total Elapsed Time in S],\n            SUM(s.execution_count) AS [Total Execution Count],\n            CAST(SUM(s.total_worker_time) / 1000000.0 AS DECIMAL(20, 2)) AS [Total CPU Time in S],\n            SUM(s.total_logical_reads) AS [Total Logical Reads],\n            SUM(s.total_logical_writes) AS [Total Logical Writes],\n            SUM(s.total_clr_time) AS [Total CLR Time],\n            COUNT(1) AS [Number of Statements],\n            MAX(s.last_execution_time) AS [Last Execution Time],\n            s.plan_handle AS [Plan Handle]\n        FROM sys.dm_exec_query_stats s WITH (NOLOCK)\n        GROUP BY s.plan_handle ORDER BY SUM(s.total_logical_reads \u002B s.total_logical_writes) DESC\n    ) TT\n) TMP\nOUTER APPLY sys.dm_exec_sql_text(TMP.[Plan Handle]) AS st\nOUTER APPLY sys.dm_exec_query_plan(TMP.[Plan Handle]) AS qp\nORDER BY Category, [Total Logical Reads] DESC\nOPTION (MAXDOP 1)"
    },
    "DriveLatency": {
      "Description": "Drive I/O latency statistics",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 30,
      "Sql": "SELECT TOP 1\n    LEFT(f.physical_name, 1) AS Drive,\n    CAST(SUM(fs.io_stall_read_ms) / NULLIF(SUM(fs.num_of_reads), 0) AS DECIMAL(10,2)) AS ReadLatencyMs,\n    CAST(SUM(fs.io_stall_write_ms) / NULLIF(SUM(fs.num_of_writes), 0) AS DECIMAL(10,2)) AS WriteLatencyMs,\n    CAST((SUM(fs.io_stall_read_ms) \u002B SUM(fs.io_stall_write_ms)) / NULLIF(SUM(fs.num_of_reads) \u002B SUM(fs.num_of_writes), 0) AS DECIMAL(10,2)) AS LatencyMs,\n    CAST(SUM(fs.num_of_bytes_read \u002B fs.num_of_bytes_written) / 1024.0 / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS GBPerDay,\n    \u0027\u0027 AS FreeSpace\nFROM sys.dm_io_virtual_file_stats(NULL, NULL) fs\nJOIN sys.master_files f ON fs.database_id = f.database_id AND fs.file_id = f.file_id\nGROUP BY LEFT(f.physical_name, 1)\nORDER BY LatencyMs DESC"
    },
    "ServerDetails": {
      "Description": "Server configuration and version info",
      "Enabled": true,
      "TimeoutSeconds": 15,
      "RefreshEveryNTicks": 60,
      "Sql": "SELECT \r\n    @@SERVERNAME AS ServerName,\r\n    --SERVERPROPERTY(\u0027Edition\u0027) AS Edition,\r\n    CASE ServerProperty(\u0027EngineEdition\u0027)\r\n \r\nWHEN 1  THEN \u0027Desktop\u0027\r\nWHEN 2  THEN \r\n    CASE \r\n    WHEN CONVERT(VARCHAR(50),SERVERPROPERTY(\u0027Edition\u0027)) LIKE \u0027%Busi%\u0027 THEN \u0027Business Intelligence\u0027\r\n    WHEN CONVERT(VARCHAR(50),SERVERPROPERTY(\u0027Edition\u0027)) LIKE \u0027%Developer%\u0027 THEN \u0027Developer\u0027\r\n    ELSE \u0027Standard\u0027-- (For Standard, Standard Developer, Web, and Business Intelligence.)\r\n    END\r\nWHEN 3  THEN \r\n-- (For Enterprise, Enterprise Developer, Developer, and Evaluation editions.)\r\n    CASE \r\n    WHEN CONVERT(VARCHAR(50),SERVERPROPERTY(\u0027Edition\u0027)) LIKE \u0027%Developer%\u0027 THEN \u0027Developer\u0027\r\n    WHEN CONVERT(VARCHAR(50),SERVERPROPERTY(\u0027Edition\u0027)) LIKE \u0027%Evaluation%\u0027 THEN \u0027Evaluation\u0027\r\n    ELSE \u0027Enterprise\u0027\r\n    END\r\n\r\nWHEN 4  THEN \u0027Express\u0027-- (For Express, Express with Tools, and Express with Advanced Services)\r\nWHEN 5  THEN \u0027SQL Database\u0027\r\nWHEN 6  THEN \u0027Azure Synapse\u0027-- Analytics\r\nWHEN 8  THEN \u0027Azure SQL MI\u0027\r\nWHEN 9  THEN \u0027Azure SQL Edge\u0027-- (For all editions of Azure SQL Edge)\r\nWHEN 11 THEN  \u0027Azure Synapse serverless\u0027-- SQL pool, or Microsoft Fabric\r\nWHEN 12 THEN  \u0027Microsoft Fabric\u0027-- SQL database in Microsoft Fabric.\r\n    END AS Edition\r\n    ,\r\n    (SELECT cpu_count FROM sys.dm_os_sys_info) AS VirtualCPUs,\r\n    (SELECT socket_count FROM sys.dm_os_sys_info) AS Sockets,\r\n    CASE WHEN (SELECT virtual_machine_type FROM sys.dm_os_sys_info) = 1 THEN \u0027VM\u0027 ELSE \u0027Physical\u0027 END AS VMType,\r\n    CAST((SELECT physical_memory_kb FROM sys.dm_os_sys_info) / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS MemoryGB,\r\n    CAST((SELECT committed_kb FROM sys.dm_os_sys_info) / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS SqlAllocated,\r\n    CAST((SELECT committed_target_kb FROM sys.dm_os_sys_info) / 1024.0 / 1024.0 AS DECIMAL(10,2)) AS UsedBySql,\r\n    \u0027\u0027 AS MemoryState,\r\n    CASE \r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u00278%\u0027    THEN \u00272000\u0027\r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u00279%\u0027    THEN \u00272005\u0027\r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002710.0%\u0027 THEN \u00272008\u0027\r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002710.5%\u0027 THEN \u00272008 R2\u0027\r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002711%\u0027   THEN \u00272012\u0027\r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002712%\u0027   THEN \u00272014\u0027\r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002713%\u0027   THEN \u00272016\u0027     \r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002714%\u0027   THEN \u00272017\u0027 \r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002715%\u0027   THEN \u00272019\u0027 \r\n     WHEN CONVERT(VARCHAR(128), SERVERPROPERTY (\u0027productversion\u0027)) like \u002716%\u0027   THEN \u00272022\u0027 \r\n     ELSE \u0027unknown\u0027\r\n  END \r\n    --@@VERSION \r\n    AS [Version],\r\n    SERVERPROPERTY(\u0027ProductVersion\u0027) AS BuildNr,\r\n    (SELECT windows_release FROM sys.dm_os_windows_info) AS OS,\r\n    CASE WHEN SERVERPROPERTY(\u0027IsHadrEnabled\u0027) = 1 THEN \u0027Yes\u0027 ELSE \u0027No\u0027 END AS HADR,\r\n    CASE WHEN EXISTS(SELECT 1 FROM sys.server_principals WHERE name = \u0027sa\u0027 AND is_disabled = 0) THEN \u0027Enabled\u0027 ELSE \u0027Disabled\u0027 END AS SA,\r\n    \u0027\u0027 AS [Level]"
    }
  }
}